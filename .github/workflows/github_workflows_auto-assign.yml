name: Auto Assign

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened, synchronize, edited]

jobs:
  # ─── Job 1: issue 和 PR 打开时，自动分配给 su600 ───────────────────────
  auto-assign-issue:
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' || github.event.action == 'opened'
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: 'Auto-assign issue or PR'
        uses: pozil/auto-assign-issue@v1
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          assignees: su600
          numOfAssignee: 1

  # ─── Job 2: 处理 Copilot commit 标记 & Review 请求（两个条件都满足才请求）──
  copilot-workflow:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.event.action == 'synchronize' || github.event.action == 'edited')
    permissions:
      pull-requests: write
      issues: write
      contents: read
    steps:
      # ── 场景 A: synchronize —— 检测 Copilot commit，打 label，并判断标题是否已无 [WIP] ──
      - name: Checkout (synchronize only)
        if: github.event.action == 'synchronize'
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if latest commit is by Copilot
        if: github.event.action == 'synchronize'
        id: check_author
        run: |
          AUTHOR_EMAIL=$(git log -1 --pretty=format:'%ae')
          AUTHOR_NAME=$(git log -1 --pretty=format:'%an')
          echo "Latest commit author: $AUTHOR_NAME <$AUTHOR_EMAIL>"
          if echo "$AUTHOR_EMAIL" | grep -iqE "copilot|github-copilot"; then
            echo "is_copilot=true" >> $GITHUB_OUTPUT
          elif echo "$AUTHOR_NAME" | grep -iqE "copilot"; then
            echo "is_copilot=true" >> $GITHUB_OUTPUT
          else
            echo "is_copilot=false" >> $GITHUB_OUTPUT
          fi

      - name: Add copilot-committed label & maybe request review (synchronize)
        if: github.event.action == 'synchronize' && steps.check_author.outputs.is_copilot == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const pr_number = context.payload.pull_request.number;
            const pr_title  = context.payload.pull_request.title;

            // 确保 label 存在
            try {
              await github.rest.issues.createLabel({
                owner, repo,
                name: 'copilot-committed',
                color: '0075ca',
                description: 'Copilot has pushed commits to this PR'
              });
            } catch (e) { /* label 已存在则忽略 */ }

            await github.rest.issues.addLabels({ owner, repo, issue_number: pr_number, labels: ['copilot-committed'] });
            console.log('✅ Label copilot-committed added');

            // 同时检查标题是否已经不含 [WIP]
            const hasWip = /\[wip\]/i.test(pr_title);
            if (!hasWip) {
              await github.rest.pulls.requestReviewers({ owner, repo, pull_number: pr_number, reviewers: ['su600'] });
              console.log('✅ Review requested from su600 (title already has no [WIP])');
            } else {
              console.log('ℹ️ Title still contains [WIP], skipping review request');
            }

      # ── 场景 B: edited —— 标题去掉了 [WIP]，且已有 copilot-committed label ──
      - name: Check title change & request review (edited)
        if: |
          github.event.action == 'edited' &&
          github.event.changes.title != null &&
          !contains(github.event.pull_request.title, '[WIP]') &&
          !contains(github.event.pull_request.title, '[wip]')
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;
            const pr_number = context.payload.pull_request.number;

            const { data: labels } = await github.rest.issues.listLabelsOnIssue({ owner, repo, issue_number: pr_number });
            const hasCopilotLabel = labels.some(l => l.name === 'copilot-committed');

            if (hasCopilotLabel) {
              await github.rest.pulls.requestReviewers({ owner, repo, pull_number: pr_number, reviewers: ['su600'] });
              console.log('✅ Review requested from su600 (Copilot had committed & [WIP] removed)');
            } else {
              console.log('ℹ️ No copilot-committed label, skipping review request');
            }